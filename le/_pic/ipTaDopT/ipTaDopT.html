<!DOCTYPE html>
<html>
 <head>
  <meta charset="UTF-8">
  <meta name="keywords" content="駒場東邦物理部,駒場東邦,駒東,KTPC,物理部,電子工作,PIC,講習">
  <meta name="description" content="駒場東邦物理部(KTPC)部員向けPIC講習の資料です。入出力の基礎を解説しています。">
  <meta name="author" content="駒場東邦物理部">
  <meta http-equiv="content-language" content="ja">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>入出力 - PIC講習 - 駒場東邦物理部</title>
  <link rel="icon" type="image/jpeg" href="../../../images/logo.jpg">
  <link rel="stylesheet" type="text/css" href="../../../style.css">
  <link rel="stylesheet" type="text/css" media="(max-width:800px)" href="../../../static.css">
  <script type="text/javascript" src="../../../header.js"></script>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-133906591-2"></script>
  <script>
   window.dataLayer = window.dataLayer || [];
   function gtag(){dataLayer.push(arguments);}
   gtag('js', new Date());
   
   gtag('config', 'UA-133906591-2');
  </script>
 </head>
 <body>
  <header class="ch00">
   <img class="ch11" src="../../../images/br.jpg">
  </header>
  <div class="chb">
   <div class="ch01">
    <div class="ch10">
     <div class="ch21">
      <button type="button" class="ch31" onclick="ck()">
       <img class="ch42" src="../../../images/menu.png">
      </button>
     </div>
     <div id="hnmu" class="ch22" style="display: none; pointer-events:none;">
      <div class="ch32">
       <span class="ch40">
        <span class="ch50">駒場東邦物理部</span>
       </span>
       <a class="ch41" href="../../../index.html">
        <span class="ch50">トップページ</span>
       </a>
       <a class="ch41" href="../../le.html">
        <span class="ch50">講習トップ</span>
       </a>
      </div>
      <div class="ch32">
       <span class="ch40">
        <span class="ch50">PIC講習</span>
       </span>
       <a class="ch41" href="../_3WqrgIaDkasI/_3WqrgIaDkasI.html">
        <span class="ch50">前回</span>
       </a>
       <a class="ch41" href="../i_dx/i_dx.html">
        <span class="ch50">索引</span>
       </a>
       <a class="ch41" href="../bTkcA/bTkcA.html">
        <span class="ch50">次回</span>
       </a>
       <a class="ch41" href="../_pic.html">
        <span class="ch50">目次</span>
       </a>
      </div>
     </div>
    </div>
   </div>
   <div class="cb00">
    <div class="cb10">
     <article class="cb20">
      <h1>PIC講習/入出力</h1>
     </article>
     <article class="cb21 fxtb">
      <h2 class="cb33">概要</h2>
      <span class="cb34">
       本章では、デジタルの入出力の基礎を解説します。<br>
       各ピンの状態はHighまたはLowのみですが、設定項目はいくつもあります。
      </span>
     </article>
     <article class="cb21 fxlr">
      <div class="cb36 debr">
       <h4 class="cb44">
        重要語
       </h4>
       <h4 class="cb45">
        入出力ピン
       </h4>
       <span class="cb41">
        入力または出力に使えるピン
       </span>
       <h4 class="cb45">
        入出力ポート
       </h4>
       <span class="cb41">
        8本ごとの入出力ピンのまとまり
       </span>
       <h4 class="cb45">
        デジタル入出力
       </h4>
       <span class="cb41">
        High/Lowの2状態による入出力
       </span>
      </div>
      <div class="cb36 debr">
       <h4 class="cb44">
        必要語
       </h4>
       <h4 class="cb45">
        レジスタ
       </h4>
       <span class="cb41">
        数値を一時記憶する回路
       </span>
       <h4 class="cb45">
        バンク
       </h4>
       <span class="cb41">
        128個分のレジスタ領域のまとまり
       </span>
      </div>
     </article>
     <article class="cb21 fxtb">
      <h2 class="cb33">入出力ピン</h2>
      <span class="cb34">
       入出力ピンは、文字通り、入力または出力の機能を持つピンです。<br>
       18ピンの16F1827には、電源供給の2本を除き、16本の入出力ピンがあります。
      </span>
     </article>
     <article class="cb21 fxrl">
      <div class="cb31">
       <h3 class="cb40">入出力ポート</h3>
       <span class="cb41">
        入出力ピンは、8本ごとに入出力ポート<span class="cb56">I/O Port</span>にまとめられています。<br>
        1827にはちょうど2つのポートがあり、ポートAとポートBという名前がついています。<br>
        また、ポートAのピンにはRA0からRA7、ポートBはRB0からRB7という名前がついています。<br>
        凹みが上に向いて見えるようにPICを置いてみましょう。<br>
        VSSとVDD以外のピンは、8ピンずつ上下に分けられます。<br>
        このとき、上側がポートAで、下側がポートBです。<br>
        RA0が17番ピン、RB0が6番ピンで、反時計回りに附番されています。
       </span>
      </div>
      <img class="cb30" src="ypT.jpg">
     </article>
     <article class="cb21">
      <div class="cb31">
       <h3 class="cb40">RA5</h3>
       <span class="cb41">
        4番ピンには、RA5という名前がありますが、このピンは入力にしか使えません。<br>
        他のピンはすべて、入力と出力の両方に使えます。<br>
        RA5が入力にしか使えない理由の1つは、リセット用の回路を内蔵していることです。<br>
        もう一つは、プログラム書き込み時にこのピンから高電圧を供給することです。<br>
        入力関係に特化したピンなので、出力回路を取り付けられなかったようです。
       </span>
      </div>
     </article>
     <article class="cb21 fxtb">
      <h2 class="cb33">ピン設定</h2>
      <span class="cb34">
       PICマイコンのピンは多機能なので、使う機能の指定も複雑です。<br>
       なお、以下で新出のレジスタはすべて、基幹レジスタではない特殊レジスタです。
      </span>
     </article>
     <article class="cb21">
      <div class="cb31">
       <h3 class="cb40">TRISA/TRISB</h3>
       <span class="cb41">
        TRISA/TRISBは、ポートA/Bの各ピンについて、入出力のいずれかを指定するレジスタです。<br>
        ビット番号に対応するピンが、0で出力、1で入力になります。<br>
        これらのレジスタには、BSRと同じように、専用の書き込み命令があります。<br>
        それぞれ、<code class="wdkywd">TRA</code>命令と<code class="wdkywd">TRB</code>命令で、Wレジスタから値を書き込めます。<br>
        <code class="wdkywd">MOV</code>命令に対する利点は、現在のバンクから変更する必要がない点です。<br>
        なお、引数はありません。<br>
        これらの命令があるので、覚えなくてもよいですが、TRISA/TRISBはバンク1にあります。
       </span>
      </div>
     </article>
     <article class="cb21">
      <div class="cb37">
       <div class="cb46">
        <span class="cb54">TRIS設定の例</span>
        <button type="button" class="cb53" onclick="copy('saco_1')">
         <span class="cb61">COPY</span>
        </button>
       </div>
       <code class="cb47">
<pre id="saco_1" class="cb55 bkgdbl">
<span class="wdp_q_p_csc_md">COL</span><span class="wdsl">.</span>TRISA<span class="wdsl">.</span><span class="wdnr">$0C</span> <span class="wdc_mt">#バンク1
</span><span class="wdp_q_p_csc_md">COL</span><span class="wdsl">.</span>TRISB<span class="wdsl">.</span><span class="wdnr">$0D</span>

<span class="wdkywd">MBS</span><span class="wdsl">.</span><span class="wdnr">1</span>
<span class="wdkywd">MOV</span><span class="wdsl">.</span><span class="wdnr">%11101000</span> <span class="wdc_mt">#RA3,RA5,RA6,RA7が入力、他は出力
</span><span class="wdkywd">MOV</span><span class="wdsl">.</span>TRISA
<span class="wdkywd">MBS</span><span class="wdsl">.</span><span class="wdnr">0</span>

<span class="wdkywd">MOV</span><span class="wdsl">.</span><span class="wdnr">%00001100</span> <span class="wdc_mt">#RB2,RB3が入力、他は出力
</span><span class="wdkywd">TRB</span><span class="wdsl">
</pre>
       </code>
      </div>
     </article>
     <article class="cb21">
      <div class="cb31">
       <h3 class="cb40">ANSELA/ANSELB</h3>
       <span class="cb41">
        ANSELA/ANSELBは、各ピンの入力がデジタルとアナログのいずれか選択するレジスタです。<br>
        0のビットに対応するピンはデジタルに、1でかつ機能を持つピンはアナログになります。<br>
        しばらくはデジタル入力しか使わないので、クリアしておきましょう。<br>
        これらのレジスタを直接設定する命令はないので、バンク3を選択しなければなりません。
       </span>
      </div>
     </article>
     <article class="cb21">
      <div class="cb37">
       <div class="cb46">
        <span class="cb54">ANSEL設定の例</span>
        <button type="button" class="cb53" onclick="copy('saco_1')">
         <span class="cb61">COPY</span>
        </button>
       </div>
       <code class="cb47">
<pre id="saco_1" class="cb55 bkgdbl">
<span class="wdp_q_p_csc_md">COL</span><span class="wdsl">.</span>ANSELA<span class="wdsl">.</span><span class="wdnr">$0C</span> <span class="wdc_mt">#バンク3
</span><span class="wdp_q_p_csc_md">COL</span><span class="wdsl">.</span>ANSELB<span class="wdsl">.</span><span class="wdnr">$0D</span>

<span class="wdkywd">MBS</span><span class="wdsl">.</span><span class="wdnr">3</span>
<span class="wdkywd">CLR</span><span class="wdsl">.</span>ANSELA     <span class="wdc_mt">#すべてデジタル入力
</span><span class="wdkywd">CLR</span><span class="wdsl">.</span>ANSELB
<span class="wdkywd">MBS</span><span class="wdsl">.</span><span class="wdnr">0</span>          <span class="wdc_mt">#バンクは忘れないうちに戻すこと</span>
</pre>
       </code>
      </div>
     </article>
     <article class="cb21">
      <div class="cb31">
       <h3 class="cb40">PORTA/PORTB</h3>
       <span class="cb41">
        PORTA/PORTBは、対応するピンの入出力の値を表すレジスタです。<br>
        これらから読み出される値は、そのときのピンの電圧に応じて、0もしくは1になります。<br>
        対応するピンが出力に設定されていても同じように動作します。<br>
        これらのレジスタに値を書き込むと、出力電圧のLow/Highを選択できます。<br>
        対応するピンが入力に設定されている場合は、何も起こりません。
       </span>
      </div>
     </article>
     <article class="cb21">
      <div class="cb37">
       <div class="cb46">
        <span class="cb54">PORT入出力の例</span>
        <button type="button" class="cb53" onclick="copy('saco_1')">
         <span class="cb61">COPY</span>
        </button>
       </div>
       <code class="cb47">
<pre id="saco_1" class="cb55 bkgdbl">
<span class="wdp_q_p_csc_md">COL</span><span class="wdsl">.</span>PORTA<span class="wdsl">.</span><span class="wdnr">$0C</span> <span class="wdc_mt">#バンク0
</span><span class="wdp_q_p_csc_md">COL</span><span class="wdsl">.</span>PORTB<span class="wdsl">.</span><span class="wdnr">$0D</span>

<span class="wdkywd">MOV</span><span class="wdsl">.</span>PORTA<span class="wdsl">.</span>W   <span class="wdc_mt">#ポートAの各ピンの電圧を読み込み
</span>
<span class="wdkywd">MOV</span><span class="wdsl">.</span><span class="wdnr">%10000100</span> <span class="wdc_mt">#RB2,RB7にHigh、他にLowを出力
</span><span class="wdkywd">MOV</span><span class="wdsl">.</span>PORTB<span class="wdsl">.</span>F   <span class="wdc_mt">#ポートBに出力</span>
</pre>
       </code>
      </div>
     </article>
     <article class="cb21">
      <div class="cb31">
       <h3 class="cb40">PORTA/PORTBの問題点</h3>
       <span class="cb41">
        POTRA/PORTBは、特定の使い方をすると、誤動作を起こします。<br>
        特に<code class="wdkywd">BCF</code>/<code class="wdkywd">BSF</code>命令が、問題を引き起こすものとして知られています。<br>
        これらの命令は、定義上1ビットのみ変更するように見えます。<br>
        しかし、PORTA/PORTBについては、他のビットを変更してしまう可能性があります。<br>
        原因の一つは、前回書き込んだ値と異なる値を読み出す可能性があることです。<br>
        PIC側でHighの電圧を出力したつもりでも、外部の回路によっては下がります。<br>
        そして、Low扱いの電圧に達することもあります。<br>
        このとき、1を書き込んだビットが、読み出すと0になってしまっています。<br>
        もう一つの理由は、これらの命令が、8ビットまとめて読み出し/書き込みを行うことです。<br>
        変更するのは1ビットでも、他のビットも転送されるのです。<br>
        これらが、<code class="wdkywd">BCF</code>/<code class="wdkywd">BSF</code>とPORTA/PORTBの組み合わせの誤作動の原因です。<br>
        つまり、Highのはずのビットを、Lowとして読み出し、そのまま書き込んでしまうのです。<br>
        なお、これはHighとLowが逆でも起こりうる現象です。<br>
        さらに、MOVでWレジスタに移し、一部のビットを変えて出力する場合なども考えられます。
       </span>
      </div>
     </article>
     <article class="cb21">
      <div class="cb31">
       <h3 class="cb40">LATA/LATB</h3>
       <span class="cb41">
        LATA/LATBは、PORTA/PORTBの欠点を補うためにつけられたレジスタです。<br>
        入力時と、出力ピン全てへの出力時には、同じ動作をします。<br>
        異なるのは、出力ピンの一部のみに出力する場合です。<br>
        このような場合には、LATA/LATBを使うのがよいでしょう。<br>
        実際の電圧ではなく、出力中の値を読み出すので、誤作動はおきません。<br>
        ただ、LATA/LATBはバンク2にあり、選択する手間がかかります。<br>
        不必要な場合には、PORTA/PORTBでよいです。
       </span>
      </div>
     </article>
     <article class="cb21">
      <div class="cb37">
       <div class="cb46">
        <span class="cb54">LAT出力の例</span>
        <button type="button" class="cb53" onclick="copy('saco_1')">
         <span class="cb61">COPY</span>
        </button>
       </div>
       <code class="cb47">
<pre id="saco_1" class="cb55 bkgdbl">
<span class="wdp_q_p_csc_md">COL</span><span class="wdsl">.</span>LATA<span class="wdsl">.</span><span class="wdnr">$0C</span> <span class="wdc_mt">#バンク2
</span><span class="wdp_q_p_csc_md">COL</span><span class="wdsl">.</span>LATB<span class="wdsl">.</span><span class="wdnr">$0D</span>

MSB<span class="wdsl">.</span><span class="wdnr">2</span>
<span class="wdkywd">BSF</span><span class="wdsl">.</span>LATA<span class="wdsl">.</span><span class="wdnr">0</span>   <span class="wdc_mt">#RA0の出力をHighにする
</span>             <span class="wdc_mt">#他のピンには影響しない
</span>MSB<span class="wdsl">.</span><span class="wdnr">0</span>
</pre>
       </code>
      </div>
     </article>
     <article class="cb21 fxtb">
      <h2 class="cb33">実際の設定と入出力</h2>
      <span class="cb34">
       PICのプログラムメモリは限られています。<br>
       効率的にプログラムを書くには、同じ命令列を何度も書くのは避けたいです。<br>
       そこで、サブルーチンと呼ばれる命令列を書き、必要な個所からジャンプする、という方法があります。<br>
       サブルーチンにジャンプすることを、サブルーチンを呼び出す<span class="cb56">call a subroutine</span>、ということがあります。<br>
       Lチカのプログラムでは、一定時間待つ命令列を、サブルーチンにしていました。
      </span>
     </article>
     <article class="cb21">
      <div class="cb31">
       <h3 class="cb40">CAL/RET命令</h3>
       <span class="cb41">
        ところで、サブルーチンを実行した後は、どこに戻ればよいのでしょうか。<br>
        複数個所から呼び出されるサブルーチンであれば、単純に<code class="wdkywd">GOT</code>命令を使うわけにもいきません。<br>
        呼び出し元のアドレスを保存してからジャンプする必要があります。<br>
        これを行うのが、<code class="wdkywd">CAL</code>命令です。<br>
        現在のプログラムカウンタを後述のスタックに保存した後、ジャンプします。<br>
        サブルーチン終了時には、<code class="wdkywd">RET</code>命令で戻り<span class="cb56">return from a subroutine</span>ます。<br>
        <code class="wdkywd">RET</code>のジャンプ先は、スタックに保存されているアドレスなので、引数はありません。
       </span>
      </div>
     </article>
     <article class="cb21">
      <div class="cb31">
       <h3 class="cb40">スタック</h3>
       <span class="cb41">
        スタックとはメモリの一つで、プログラムカウンタを保存できます。<br>
        ただし、サブルーチンからさらにサブルーチンを呼び出す状況なども考えられます。<br>
        そのため、16F1827では、16段の領域があり、16重までの多重呼び出しが可能です。<br>
        しかし、安全のため、8重以上になるような状況は避けましょう。<br>
        なお、スタックは最後に保存された値から順に取り出される構造になっています。
       </span>
      </div>
     </article>
     <article class="cb21">
      <div class="cb37">
       <div class="cb46">
        <span class="cb54">サブルーチンの例</span>
        <button type="button" class="cb53" onclick="copy('saco_2')">
         <span class="cb61">COPY</span>
        </button>
       </div>
       <code class="cb47">
<pre id="saco_2" class="cb55 bkgdbl">
<span class="wdkywd">CAL</span><span class="wdsl">.</span>SRA   <span class="wdc_mt">#サブルーチンSRAを呼び出す
</span>
<span class="wdp_q_p_csc_md">COL</span><span class="wdsl">.</span>SRA   <span class="wdc_mt">#サブルーチンSRAはここから
</span>  <span class="wdkywd">NOP</span>     <span class="wdc_mt">#ここにサブルーチンの内容おい
</span>  <span class="wdkywd">CAL</span><span class="wdsl">.</span>SRB <span class="wdc_mt">#別のサブルーチンを呼び出してもよい
</span>  <span class="wdkywd">RET</span>     <span class="wdc_mt">#サブルーチンSRAはここで終わり
</span>
<span class="wdp_q_p_csc_md">COL</span><span class="wdsl">.</span>SRB   <span class="wdc_mt">#サブルーチンSRBはここから
</span>  <span class="wdkywd">NOP</span>
  <span class="wdkywd">RET</span>     <span class="wdc_mt">#ここまで</span>
</pre>
       </code>
      </div>
     </article>
    </div>
   </div>
   <footer class="cf00">
    <div class="cf10">
     <button class="cf21" onclick="tp()">
      <img class="cf30" src="../../../images/top.png">
     </button>
     <span class="cf20">
      (C) 2020 駒場東邦物理部[KTPC]
     </span>
    </div>
   </footer>
  </div>
 </body>
</html>
